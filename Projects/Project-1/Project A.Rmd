---
title: "Homework Project A"
author: "Waheeb Algabri, William Berritt, Kossi Akplaka"
output:
  html_document:
    highlight: pygments
    theme: cerulean
    toc: true
    toc_float: true
  pdf_document: default
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, error = TRUE)
```


### Introduction

In today's data-driven world, the ability to forecast accurately is crucial for strategic planning and decision-making. This project aims to harness the power of historical data to generate reliable forecasts for various series within a de-identified dataset. With a comprehensive dataset spanning 1622 periods, we will employ advanced data analysis and forecasting techniques to predict future trends for the next 140 periods.

This report is crafted to cater to a diverse audience, ranging from individuals with no background in data science to seasoned data scientists. Our goal is to present the analysis and findings in a clear, concise, and accessible manner. We will explain the methodologies used, the rationale behind their selection, and the step-by-step process of our analysis, ensuring transparency and comprehensibility for all readers.

The report is structured to balance technical rigor with simplicity, providing a thorough yet comprehensible narrative of our forecasting journey. We begin with an exploration of the data, followed by a detailed explanation of the forecasting methods applied, and conclude with the results and their implications. Visualizations and key insights will be highlighted to enhance understanding and readability.

By leveraging fundamental techniques, thorough data exploration, and robust forecasting methods, this project not only aims to achieve high accuracy in predictions but also to demonstrate the importance of effective communication in data science. The accompanying Excel workbook will include the forecasted values for each category, organized systematically to facilitate error rate calculations and further analysis.

Loading necessary Packages


```{r, error=TRUE}
library(ggplot2)
library(readxl)
library(fpp3)
library(kableExtra)
library(tidyverse)
library(forecast)
library(openxlsx)
```

### Data exploration 

Read the excel file and extract the data

```{r}
df <- readxl::read_excel("Data set for Class.xls")
```

using glimpse, so we can view the attributes of our dataset

```{r}
glimpse(df)
```

Dataset have 10,572 rows and 7 columns.

```{r}
kable(head(df), caption = "First 6 Rows of Data")
```

check if there are any missing values in the entire dataframe
```{r}
any(is.na(df))

```

count the number of missing values in the entire dataframe
```{r}
sum(is.na(df))

```


```{r}
# Identify numeric columns
numeric_columns <- sapply(df, is.numeric)

# Apply mean imputation to numeric columns
for (col in names(df)[numeric_columns]) {
  df[[col]][is.na(df[[col]])] <- mean(df[[col]], na.rm = TRUE)
}

# For non-numeric columns, we decide to use on a different imputation method, like using the mode for categorical columns
# Define a function to get the mode
getmode <- function(v) {
  uniqv <- unique(v)
  uniqv[which.max(tabulate(match(v, uniqv)))]
}

# Apply mode imputation to non-numeric columns
for (col in names(df)[!numeric_columns]) {
  df[[col]][is.na(df[[col]])] <- getmode(df[[col]])
}

```

Make sure if there is more missing values 
```{r}
sum(is.na(df))
```

In order to forecast each variable within each group, we needed to break the larger dataset into its individual groups so we could perform our analysis and properly visualize our data.

### Data Preparation

**Split Data into Categories**

Separate the data into six sheets based on the category column.
```{r}
library(dplyr)
categories <- unique(df$category)

for (cat in categories) {
  assign(paste0("df_", cat), df %>% filter(category == cat))
}

```

**Sort Each Sheet by SeriesInd**

```{r}
for (cat in categories) {
  assign(paste0("df_", cat), get(paste0("df_", cat)) %>% arrange(SeriesInd))
}

```


### Exploratory Data Analysis (EDA)

```{r}
summary(df)

```

Visualization

```{r}
# Line plot for Var01 by category
ggplot(df, aes(x = SeriesInd, y = Var01, group = category, color = category)) +
  geom_line() +
  labs(x = "Series Indicator", y = "Var01") +
  ggtitle("Trend and Seasonality of Var01 by Category")

```

```{r}

# Line plot for Var01 by category
ggplot(df, aes(x = SeriesInd, y = Var02, group = category, color = category)) +
  geom_line() +
  labs(x = "Series Indicator", y = "Var02") +
  ggtitle("Trend and Seasonality of Var02 by Category")

```

```{r}
# Line plot for Var01 by category
ggplot(df, aes(x = SeriesInd, y = Var03, group = category, color = category)) +
  geom_line() +
  labs(x = "Series Indicator", y = "Var03") +
  ggtitle("Trend and Seasonality of Var01 by Category")
```

```{r}
# Line plot for Var01 by category
ggplot(df, aes(x = SeriesInd, y = Var05, group = category, color = category)) +
  geom_line() +
  labs(x = "Series Indicator", y = "Var03") +
  ggtitle("Trend and Seasonality of Var01 by Category")
```

```{r}
# Line plot for Var01 by category
ggplot(df, aes(x = SeriesInd, y = Var07, group = category, color = category)) +
  geom_line() +
  labs(x = "Series Indicator", y = "Var03") +
  ggtitle("Trend and Seasonality of Var01 by Category")
```



### Methodology:
we chose ARIMA beacuse the AutoRegressive Integrated Moving Average (ARIMA) model is a popular and flexible method for time series forecasting. ARIMA models account for various patterns in the data, such as trends and seasonality, making them suitable for our analysis. We use ARIMA because it is well-suited for univariate time series forecasting, where the future value of a variable is predicted based on its own past values.

### Forecasts

### {.tabset}
#### S01: Forecast Var01, Var02

##### Forecast Var01:
```{r}
df_S01 <- df %>% filter(category == "S01")

# Fit ARIMA model
fit_Var01_S01 <- auto.arima(df_S01$Var01)

# Forecast next 140 periods
forecast_Var01_S01 <- forecast(fit_Var01_S01, h = 140)

# Plot forecast
autoplot(forecast_Var01_S01) + 
  labs(title = "Forecast of Var01 for S01", x = "Time", y = "Var01")

# Save forecast results
forecast_Var01_S01_df <- data.frame(
  SeriesInd = max(df_S01$SeriesInd) + 1:max(140),
  Var01 = as.numeric(forecast_Var01_S01$mean)
)

```



##### Forecast Var02:
```{r}
# Fit ARIMA model
fit_Var02_S01 <- auto.arima(df_S01$Var02)

# Forecast next 140 periods
forecast_Var02_S01 <- forecast(fit_Var02_S01, h = 140)

# Plot forecast
autoplot(forecast_Var02_S01) + 
  labs(title = "Forecast of Var02 for S01", x = "Time", y = "Var02")

# Save forecast results
forecast_Var02_S01_df <- data.frame(
  SeriesInd = max(df_S01$SeriesInd) + 1:max(140),
  Var02 = as.numeric(forecast_Var02_S01$mean)
)

```




#### S02: Forecast Var02, Var03

##### Forecast Var02:
```{r}
df_S02 <- df %>% filter(category == "S02")

# Fit ARIMA model
fit_Var02_S02 <- auto.arima(df_S02$Var02)

# Forecast next 140 periods
forecast_Var02_S02 <- forecast(fit_Var02_S02, h = 140)

# Plot forecast
autoplot(forecast_Var02_S02) + 
  labs(title = "Forecast of Var02 for S02", x = "Time", y = "Var02")

# Save forecast results
forecast_Var02_S02_df <- data.frame(
  SeriesInd = max(df_S02$SeriesInd) + 1:max(140),
  Var02 = as.numeric(forecast_Var02_S02$mean)
)

```

##### Forecast Var03:

```{r}
# Fit ARIMA model
fit_Var03_S02 <- auto.arima(df_S02$Var03)

# Forecast next 140 periods
forecast_Var03_S02 <- forecast(fit_Var03_S02, h = 140)

# Plot forecast
autoplot(forecast_Var03_S02) + 
  labs(title = "Forecast of Var03 for S02", x = "Time", y = "Var03")

# Save forecast results
forecast_Var03_S02_df <- data.frame(
  SeriesInd = max(df_S02$SeriesInd) + 1:max(140),
  Var03 = as.numeric(forecast_Var03_S02$mean)
)

```


#### S03: Forecast Var05, Var07

##### Forecast Var05

```{r}
df_S03 <- df %>% filter(category == "S03")

# Fit ARIMA model
fit_Var05_S03 <- auto.arima(df_S03$Var05)

# Forecast next 140 periods
forecast_Var05_S03 <- forecast(fit_Var05_S03, h = 140)

# Plot forecast
autoplot(forecast_Var05_S03) + 
  labs(title = "Forecast of Var05 for S03", x = "Time", y = "Var05")

# Save forecast results
forecast_Var05_S03_df <- data.frame(
  SeriesInd = max(df_S03$SeriesInd) + 1:max(140),
  Var05 = as.numeric(forecast_Var05_S03$mean)
)

```

##### Forecast Var07

```{r}
# Fit ARIMA model
fit_Var07_S03 <- auto.arima(df_S03$Var07)

# Forecast next 140 periods
forecast_Var07_S03 <- forecast(fit_Var07_S03, h = 140)

# Plot forecast
autoplot(forecast_Var07_S03) + 
  labs(title = "Forecast of Var07 for S03", x = "Time", y = "Var07")

# Save forecast results
forecast_Var07_S03_df <- data.frame(
  SeriesInd = max(df_S03$SeriesInd) + 1:max(140),
  Var07 = as.numeric(forecast_Var07_S03$mean)
)

```


#### S04: Forecast Var01, Var02

```{r}
df_S04 <- df %>% filter(category == "S04")

# Fit ARIMA model
fit_Var01_S04 <- auto.arima(df_S04$Var01)

# Forecast next 140 periods
forecast_Var01_S04 <- forecast(fit_Var01_S04, h = 140)

# Plot forecast
autoplot(forecast_Var01_S04) + 
  labs(title = "Forecast of Var01 for S04", x = "Time", y = "Var01")

# Save forecast results
forecast_Var01_S04_df <- data.frame(
  SeriesInd = max(df_S04$SeriesInd) + 1:max(140),
  Var01 = as.numeric(forecast_Var01_S04$mean)
)

```

##### Forecast Var02:
```{r}
# Fit ARIMA model
fit_Var02_S04 <- auto.arima(df_S04$Var02)

# Forecast next 140 periods
forecast_Var02_S04 <- forecast(fit_Var02_S04, h = 140)

# Plot forecast
autoplot(forecast_Var02_S04) + 
  labs(title = "Forecast of Var02 for S04", x = "Time", y = "Var02")

# Save forecast results
forecast_Var02_S04_df <- data.frame(
  SeriesInd = max(df_S04$SeriesInd) + 1:max(140),
  Var02 = as.numeric(forecast_Var02_S04$mean)
)

```



#### S05: Forecast Var02, Var03
##### Forecast Var02:
```{r}
df_S05 <- df %>% filter(category == "S05")

# Fit ARIMA model
fit_Var02_S05 <- auto.arima(df_S05$Var02)

# Forecast next 140 periods
forecast_Var02_S05 <- forecast(fit_Var02_S05, h = 140)

# Plot forecast
autoplot(forecast_Var02_S05) + 
  labs(title = "Forecast of Var02 for S05", x = "Time", y = "Var02")

# Save forecast results
forecast_Var02_S05_df <- data.frame(
  SeriesInd = max(df_S05$SeriesInd) + 1:max(140),
  Var02 = as.numeric(forecast_Var02_S05$mean)
)

```

##### Forecast Var03:
```{r}
# Fit ARIMA model
fit_Var03_S05 <- auto.arima(df_S05$Var03)

# Forecast next 140 periods
forecast_Var03_S05 <- forecast(fit_Var03_S05, h = 140)

# Plot forecast
autoplot(forecast_Var03_S05) + 
  labs(title = "Forecast of Var03 for S05", x = "Time", y = "Var03")

# Save forecast results
forecast_Var03_S05_df <- data.frame(
  SeriesInd = max(df_S05$SeriesInd) + 1:max(140),
  Var03 = as.numeric(forecast_Var03_S05$mean)
)

```


#### S06: Forecast Var05, Var07
##### Forecast Var05:

```{r}
df_S06 <- df %>% filter(category == "S06")

# Fit ARIMA model
fit_Var05_S06 <- auto.arima(df_S06$Var05)

# Forecast next 140 periods
forecast_Var05_S06 <- forecast(fit_Var05_S06, h = 140)

# Plot forecast
autoplot(forecast_Var05_S06) + 
  labs(title = "Forecast of Var05 for S06", x = "Time", y = "Var05")

# Save forecast results
forecast_Var05_S06_df <- data.frame(
  SeriesInd = max(df_S06$SeriesInd) + 1:max(140),
  Var05 = as.numeric(forecast_Var05_S06$mean)
)

```

##### Forecast Var07:

```{r}
# Fit ARIMA model
fit_Var07_S06 <- auto.arima(df_S06$Var07)

# Forecast next 140 periods
forecast_Var07_S06 <- forecast(fit_Var07_S06, h = 140)

# Plot forecast
autoplot(forecast_Var07_S06) + 
  labs(title = "Forecast of Var07 for S06", x = "Time", y = "Var07")

# Save forecast results
forecast_Var07_S06_df <- data.frame(
  SeriesInd = max(df_S06$SeriesInd) + 1:max(140),
  Var07 = as.numeric(forecast_Var07_S06$mean)
)

```


### Result 

Save Forecast Results into Excel Sheets
Now that we have the forecast results for all specified variables and categories, let's save them into an Excel workbook.



## Data

```{r}
s02 <- read_excel('Data set for Class.xls',
                  sheet = 'S02', skip = 2)
s05 <- read_excel('Data set for Class.xls',
                  sheet = 'S05', skip = 2)

df <- left_join(
  select(s02, SeriesInd, Var02, Var03),
  select(s05, SeriesInd, Var03),
  by = 'SeriesInd', keep = FALSE)
```

```{r}
head(df)
tail(df)
```

```{r}
df <- df %>%
  rename(date = SeriesInd,
         s02_v02 = Var02,
         s02_v03 = Var03.x,
         s05_v03 = Var03.y)

# for (row in 1623:nrow(df)) {
#   df[row, 's02_v02'] <- NA
#   df[row, 's02_v03'] <- NA
#   df[row, 's05_v03'] <- NA
# }
# df[1620:1625,]

df <- df[1:1622,]

# as_tsibble(df, index = date, regular = TRUE) %>%
#   model(classical_decomposition(s02_v02)) %>%
#   components()
```


```{r}
ggplot(df, aes(date, s02_v02)) +
  geom_line()

ggplot(df, aes(date, s02_v03)) +
  geom_line()

ggplot(df, aes(date, s05_v03)) +
  geom_line()
```

```{r}
data.frame(date = df$date[2:nrow(df)], s02_v02 = diff(df$s02_v02)) %>%
  ggplot(aes(date, s02_v02)) +
  geom_line()

data.frame(date = df$date[2:nrow(df)], s02_v03 = diff(df$s02_v03)) %>%
  ggplot(aes(date, s02_v03)) +
  geom_line()

data.frame(date = df$date[2:nrow(df)], s05_v03 = diff(df$s05_v03)) %>%
  ggplot(aes(date, s05_v03)) +
  geom_line()
```

```{r}
diff(filter(df, !is.na(s05_v03))$s05_v03) %>%
  tseries::adf.test()
```


```{r}
for (col in colnames(df)[2:4]) {
  print(ggAcf(xts(df[col], df$date)))
  print(ggPacf(xts(df[col], df$date)))
  print(gglagplot(xts(df[col], df$date, continuous = FALSE, seasonal = FALSE)))
}
```

```{r}
for (p in seq(1:5)) {
  for (q in seq(1:5)) {
    results <- Arima(df$s02_v02, order = c(1,1,q))
    cat('For p =',p,'and','q =',q,', AICc is',results$aicc,'\n')
  }
}
```

```{r}
auto.arima(df$s02_v02, approximation = FALSE, stepwise = FALSE)
```

```{r}
model <- auto.arima(df$s02_v02, approximation = FALSE, stepwise = FALSE)
checkresiduals(model)
autoplot(forecast(model, h = 140))
```


```{r}
model <- auto.arima(df$s02_v03, approximation = FALSE, stepwise = FALSE)
checkresiduals(model)
autoplot(forecast(model, h = 140))
```


```{r}
model <- auto.arima(df$s05_v03, approximation = FALSE, stepwise = FALSE)
checkresiduals(model)
autoplot(forecast(model, h = 140))
```



